<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Graph Analyzer - Network Optimization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .user-info {
            font-size: 1.2em;
            margin-top: 10px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #1e3c72;
        }

        .login-screen {
            padding: 60px 40px;
            text-align: center;
        }

        .login-screen h2 {
            color: #333;
            margin-bottom: 40px;
            font-size: 2em;
        }

        .user-select {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .user-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px 60px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            font-size: 1.5em;
            font-weight: bold;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .main-content {
            padding: 30px;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
            font-weight: bold;
        }

        .tab:hover {
            color: #1e3c72;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .node-card {
            background: #f9f9f9;
            border-left: 4px solid #1e3c72;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .node-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .node-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #1e3c72;
        }

        .node-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .badge {
            background: #1e3c72;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .badge-romantic {
            background: #e74c3c;
        }

        .badge-social {
            background: #27ae60;
        }

        .badge-high {
            background: #f39c12;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .kpi-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .kpi-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 5px;
        }

        .kpi-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #1e3c72;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .event-card {
            background: #f9f9f9;
            border-left: 4px solid #27ae60;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .hidden {
            display: none;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1e3c72;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1e3c72;
            cursor: pointer;
            border: none;
        }

        .color-picker {
            width: 60px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .network-viz {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            text-align: center;
        }

        .section-title {
            color: #1e3c72;
            font-size: 1.2em;
            margin: 25px 0 15px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginScreen" class="login-screen">
            <h2>Selecciona tu usuario</h2>
            <div class="user-select">
                <div class="user-card" onclick="login('Dani')">
                    üë§ Dani
                </div>
                <div class="user-card" onclick="login('Edu')">
                    üë§ Edu
                </div>
            </div>
        </div>

        <div id="appScreen" class="hidden">
            <div class="header">
                <h1>üï∏Ô∏è Social Graph Analyzer</h1>
                <div class="user-info">User: <span id="currentUser"></span></div>
                <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <div class="main-content">
                <div class="nav-tabs">
                    <button class="tab active" onclick="showTab('nodes')">üë• Nodos</button>
                    <button class="tab" onclick="showTab('events')">üìÖ Eventos</button>
                    <button class="tab" onclick="showTab('network')">üï∏Ô∏è Red</button>
                    <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
                    <button class="tab" onclick="showTab('spawn')">üéØ High-Value Zones</button>
                    <button class="tab" onclick="showTab('profile')">‚öôÔ∏è Mi Perfil</button>
                </div>

                <div id="nodesTab" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h2>Gesti√≥n de Nodos (Personas)</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small" onclick="exportNodes()">üì• Export CSV</button>
                            <button class="btn" onclick="openNodeModal()">‚ûï Nuevo Nodo</button>
                        </div>
                    </div>
                    <div id="nodesList"></div>
                </div>

                <div id="eventsTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h2>Event Logs</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small" onclick="exportEvents()">üì• Export CSV</button>
                            <button class="btn btn-small" onclick="exportAllData()">üì¶ Export All (JSON)</button>
                            <button class="btn" onclick="openEventModal()">‚ûï Nuevo Evento</button>
                        </div>
                    </div>
                    <div id="eventsList"></div>
                </div>

                <div id="networkTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Visualizaci√≥n de Red Social</h2>
                        <button class="btn btn-small" onclick="refreshNetwork()">üîÑ Actualizar</button>
                    </div>
                    <canvas id="networkCanvas" width="1200" height="600" style="border: 1px solid #ddd; border-radius: 10px; background: #f9f9f9; width: 100%; max-width: 1200px;"></canvas>
                    <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                        <strong>Leyenda:</strong>
                        <span style="margin-left: 20px;">üî¥ Alto Valor Rom√°ntico</span>
                        <span style="margin-left: 20px;">üü¢ Alto Valor Social</span>
                        <span style="margin-left: 20px;">üîµ Alta Confianza</span>
                        <span style="margin-left: 20px;">‚ö™ Normal</span>
                    </div>
                </div>

                <div id="analyticsTab" class="tab-content">
                    <h2>Analytics & KPIs</h2>
                    <div class="stats-grid" id="analyticsGrid"></div>
                    <div class="section-title">Top Nodes por Categor√≠a</div>
                    <div id="topNodes"></div>
                </div>

                <div id="spawnTab" class="tab-content">
                    <h2>üéØ High-Value Node Spawn Analysis</h2>
                    <div id="spawnAnalysis"></div>
                </div>

                <div id="profileTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Mi Perfil (OwnData)</h2>
                        <button class="btn btn-small" onclick="saveOwnData()">üíæ Guardar Perfil</button>
                    </div>

                    <form id="ownDataForm">
                        <div class="section-title">Informaci√≥n Personal</div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Hobbies Actuales</label>
                                <input type="text" id="ownHobbies" placeholder="Separados por comas">
                            </div>
                            <div class="form-group">
                                <label>Actividades Actuales</label>
                                <input type="text" id="ownCurrentActivities" placeholder="Qu√© est√°s haciendo ahora">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Estado Sentimental</label>
                                <select id="ownIsInLove">
                                    <option value="single">Soltero/a</option>
                                    <option value="dating">Saliendo con alguien</option>
                                    <option value="relationship">En una relaci√≥n</option>
                                    <option value="complicated">Es complicado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Disponibilidad Social</label>
                                <select id="ownAvailability">
                                    <option value="high">Alta - Mucho tiempo libre</option>
                                    <option value="medium">Media - Algo de tiempo</option>
                                    <option value="low">Baja - Poco tiempo</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Trabajo/Estudios</label>
                            <input type="text" id="ownJob" placeholder="Tu ocupaci√≥n actual">
                        </div>

                        <div class="form-group">
                            <label>Objetivos a Largo Plazo</label>
                            <textarea id="ownLongTermGoals" placeholder="¬øQu√© quieres lograr en los pr√≥ximos a√±os?"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Sue√±os Alcanzados</label>
                            <textarea id="ownDreamsAchieved" placeholder="¬øQu√© has logrado hasta ahora?"></textarea>
                        </div>

                        <div class="section-title">Auto-Evaluaci√≥n (1-10)</div>

                        <div class="form-group">
                            <label>Nivel de Involucramiento Social: <span id="ownInvolvementDisplay">5</span></label>
                            <input type="range" class="slider" id="ownInvolvement" min="1" max="10" value="5" oninput="updateOwnSlider('Involvement')">
                        </div>

                        <div class="form-group">
                            <label>Nivel de Fitness: <span id="ownFitnessDisplay">5</span></label>
                            <input type="range" class="slider" id="ownFitness" min="1" max="10" value="5" oninput="updateOwnSlider('Fitness')">
                        </div>

                        <div class="form-group">
                            <label>Nivel de Originalidad: <span id="ownOriginalityDisplay">5</span></label>
                            <input type="range" class="slider" id="ownOriginality" min="1" max="10" value="5" oninput="updateOwnSlider('Originality')">
                        </div>

                        <div class="form-group">
                            <label>Nivel de Ego√≠smo (honesto): <span id="ownEgoismDisplay">5</span></label>
                            <input type="range" class="slider" id="ownEgoism" min="1" max="10" value="5" oninput="updateOwnSlider('Egoism')">
                        </div>

                        <div class="form-group">
                            <label>Nivel de Inteligencia: <span id="ownIntelligenceDisplay">5</span></label>
                            <input type="range" class="slider" id="ownIntelligence" min="1" max="10" value="5" oninput="updateOwnSlider('Intelligence')">
                        </div>

                        <div class="form-group">
                            <label>Gusto Musical</label>
                            <input type="text" id="ownMusicTaste" placeholder="G√©neros, artistas favoritos...">
                        </div>

                        <div class="section-title">Estado Actual</div>
                        <div id="ownDataSummary" style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 15px;">
                            <p style="color: #666;">Guarda tu perfil para ver un resumen de tu estado actual.</p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Node Modal -->
    <div id="nodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gestionar Nodo</h2>
                <span class="close" onclick="closeNodeModal()">&times;</span>
            </div>
            <form id="nodeForm" onsubmit="saveNode(event)">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="nodeName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Edad</label>
                        <input type="number" id="nodeAge" min="0">
                    </div>
                    <div class="form-group">
                        <label>Color del Nodo</label>
                        <input type="color" id="nodeColor" class="color-picker" value="#3498db">
                    </div>
                </div>

                <div class="section-title">Atributos</div>

                <div class="form-group">
                    <label>Trabajo/Ocupaci√≥n</label>
                    <input type="text" id="nodeJob">
                </div>

                <div class="form-group">
                    <label>Hobbies (separados por comas)</label>
                    <input type="text" id="nodeHobbies" placeholder="Ej: M√∫sica, Deportes, Lectura">
                </div>

                <div class="form-group">
                    <label>Objetivos a largo plazo</label>
                    <textarea id="nodeLongTermGoals"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>¬øEst√° enamorado/a?</label>
                        <select id="nodeIsInLove">
                            <option value="no">No</option>
                            <option value="yes">S√≠</option>
                            <option value="unknown">Desconocido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de relaci√≥n cercana</label>
                        <select id="nodeRelationType">
                            <option value="">Selecciona...</option>
                            <option value="amigo">Amigo</option>
                            <option value="familia">Familia</option>
                            <option value="pareja">Pareja</option>
                            <option value="conocido">Conocido</option>
                            <option value="profesional">Profesional</option>
                        </select>
                    </div>
                </div>

                <div class="section-title">Heur√≠sticas & KPIs (1-10)</div>

                <div class="form-group">
                    <label>Valor Rom√°ntico: <span id="romanticValueDisplay">5</span></label>
                    <input type="range" class="slider" id="nodeRomanticValue" min="0" max="10" value="5" oninput="updateSlider('romanticValue')">
                </div>

                <div class="form-group">
                    <label>Valor Social (networking): <span id="socialValueDisplay">5</span></label>
                    <input type="range" class="slider" id="nodeSocialValue" min="0" max="10" value="5" oninput="updateSlider('socialValue')">
                </div>

                <div class="form-group">
                    <label>Nivel de Confianza: <span id="trustLevelDisplay">5</span></label>
                    <input type="range" class="slider" id="nodeTrustLevel" min="0" max="10" value="5" oninput="updateSlider('trustLevel')">
                </div>

                <div class="section-title">Lugares Predecibles</div>

                <div class="form-group">
                    <label>Lugares frecuentes (separados por comas)</label>
                    <input type="text" id="nodePlaces" placeholder="Ej: Universidad, Bar Central, Gimnasio">
                </div>

                <div class="form-group">
                    <label>Highlights / Notas importantes</label>
                    <textarea id="nodeHighlights" placeholder="Cualquier informaci√≥n relevante sobre esta persona..."></textarea>
                </div>

                <button type="submit" class="btn">üíæ Guardar Nodo</button>
                <button type="button" class="btn btn-danger btn-small" onclick="deleteNode()" id="deleteNodeBtn" style="display:none; margin-left: 10px;">üóëÔ∏è Eliminar</button>
            </form>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Evento</h2>
                <span class="close" onclick="closeEventModal()">&times;</span>
            </div>
            <form id="eventForm" onsubmit="saveEvent(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label>Hora</label>
                        <input type="time" id="eventTime">
                    </div>
                </div>

                <div class="form-group">
                    <label>Nodos participantes *</label>
                    <select id="eventNodes" multiple size="5" required style="height: 120px;">
                    </select>
                    <small style="color: #666;">Mant√©n Ctrl/Cmd para seleccionar m√∫ltiples</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Lugar *</label>
                        <input type="text" id="eventPlace" required>
                    </div>
                    <div class="form-group">
                        <label>Clima</label>
                        <select id="eventWeather">
                            <option value="">Selecciona...</option>
                            <option value="soleado">‚òÄÔ∏è Soleado</option>
                            <option value="nublado">‚òÅÔ∏è Nublado</option>
                            <option value="lluvioso">üåßÔ∏è Lluvioso</option>
                            <option value="nevado">‚ùÑÔ∏è Nevado</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Outfit</label>
                        <input type="text" id="eventOutfit" placeholder="Ej: Camisa azul, jeans">
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de personas</label>
                        <input type="number" id="eventPeopleCount" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Situaci√≥n/Objetivo</label>
                    <input type="text" id="eventSituation" placeholder="Ej: Cena casual, Networking, Estudio">
                </div>

                <div class="form-group">
                    <label>Ambiente/Environment</label>
                    <textarea id="eventEnvironment" placeholder="Describe el ambiente, ruido, iluminaci√≥n, etc."></textarea>
                </div>

                <div class="form-group">
                    <label>Notas del evento</label>
                    <textarea id="eventNotes"></textarea>
                </div>

                <button type="submit" class="btn">üíæ Guardar Evento</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAaPppC8tW7hCOxukO3BL9BZs4-LR5l5LQ",
            authDomain: "farmeo-dbd64.firebaseapp.com",
            projectId: "farmeo-dbd64",
            storageBucket: "farmeo-dbd64.firebasestorage.app",
            messagingSenderId: "808054624580",
            appId: "1:808054624580:web:67be1341b6e361c9ad8711"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let allNodes = [];
        let allEvents = [];
        let currentNodeId = null;

        // Login
        window.login = async function(username) {
            currentUser = username;
            document.getElementById('currentUser').textContent = username;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            await loadData();
        };

        // Logout
        window.logout = function() {
            currentUser = null;
            allNodes = [];
            allEvents = [];
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        };

        // Load all data
        async function loadData() {
            await loadNodes();
            await loadEvents();
            renderNodes();
        }

        // Load nodes
        async function loadNodes() {
            try {
                const q = query(collection(db, 'nodes'), where('user', '==', currentUser));
                const querySnapshot = await getDocs(q);
                allNodes = [];
                querySnapshot.forEach((doc) => {
                    allNodes.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${allNodes.length} nodes`);
            } catch (error) {
                console.error('Error loading nodes:', error);
                alert('Error al cargar nodos: ' + error.message);
            }
        }

        // Load events
        async function loadEvents() {
            try {
                const q = query(collection(db, 'events'), where('user', '==', currentUser));
                const querySnapshot = await getDocs(q);
                allEvents = [];
                querySnapshot.forEach((doc) => {
                    allEvents.push({ id: doc.id, ...doc.data() });
                });
                allEvents.sort((a, b) => b.date.localeCompare(a.date));
                console.log(`Loaded ${allEvents.length} events`);
            } catch (error) {
                console.error('Error loading events:', error);
                alert('Error al cargar eventos: ' + error.message);
            }
        }

        // Tab navigation
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'nodes') renderNodes();
            else if (tabName === 'events') renderEvents();
            else if (tabName === 'network') renderNetwork();
            else if (tabName === 'analytics') renderAnalytics();
            else if (tabName === 'spawn') renderSpawnAnalysis();
            else if (tabName === 'profile') renderProfile();
        };

        // Render nodes list
        function renderNodes() {
            if (allNodes.length === 0) {
                document.getElementById('nodesList').innerHTML = '<p>No has creado ning√∫n nodo a√∫n. Haz click en "Nuevo Nodo" para empezar.</p>';
                return;
            }

            const html = allNodes.map(node => `
                <div class="node-card" onclick="editNode('${node.id}')">
                    <div class="node-header">
                        <div>
                            <div class="node-name" style="border-left: 4px solid ${node.color || '#3498db'}; padding-left: 10px;">
                                ${node.name}
                            </div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                ${node.job || 'Sin trabajo'} ${node.age ? `‚Ä¢ ${node.age} a√±os` : ''}
                            </div>
                        </div>
                        <div class="node-badges">
                            ${node.romanticValue >= 7 ? '<span class="badge badge-romantic">üíï High Romantic</span>' : ''}
                            ${node.socialValue >= 7 ? '<span class="badge badge-social">üåü High Social</span>' : ''}
                            ${node.trustLevel >= 8 ? '<span class="badge badge-high">üîí High Trust</span>' : ''}
                        </div>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-item">
                            <div class="kpi-label">Rom√°ntico</div>
                            <div class="kpi-value">${node.romanticValue || 0}/10</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Social</div>
                            <div class="kpi-value">${node.socialValue || 0}/10</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Confianza</div>
                            <div class="kpi-value">${node.trustLevel || 0}/10</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Eventos</div>
                            <div class="kpi-value">${countNodeEvents(node.id)}</div>
                        </div>
                    </div>
                    ${node.places ? `<p style="margin-top: 10px;"><strong>üìç Lugares:</strong> ${node.places}</p>` : ''}
                    ${node.hobbies ? `<p><strong>üéØ Hobbies:</strong> ${node.hobbies}</p>` : ''}
                </div>
            `).join('');

            document.getElementById('nodesList').innerHTML = html;
        }

        // Render events
        function renderEvents() {
            if (allEvents.length === 0) {
                document.getElementById('eventsList').innerHTML = '<p>No has registrado ning√∫n evento a√∫n.</p>';
                return;
            }

            const html = allEvents.map(evt => {
                const nodeNames = evt.nodes ? evt.nodes.map(nid => {
                    const node = allNodes.find(n => n.id === nid);
                    return node ? node.name : 'Desconocido';
                }).join(', ') : '';

                return `
                    <div class="event-card">
                        <div class="event-header">
                            <span>üìÖ ${evt.date} ${evt.time || ''}</span>
                            <span>üìç ${evt.place}</span>
                        </div>
                        <p><strong>üë• Nodos:</strong> ${nodeNames}</p>
                        ${evt.situation ? `<p><strong>üéØ Situaci√≥n:</strong> ${evt.situation}</p>` : ''}
                        ${evt.weather ? `<p><strong>üå§Ô∏è Clima:</strong> ${evt.weather}</p>` : ''}
                        ${evt.outfit ? `<p><strong>üëî Outfit:</strong> ${evt.outfit}</p>` : ''}
                        ${evt.peopleCount ? `<p><strong>üë• Personas:</strong> ${evt.peopleCount}</p>` : ''}
                        ${evt.notes ? `<p style="margin-top: 10px; font-style: italic;">${evt.notes}</p>` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('eventsList').innerHTML = html;
        }

        // Render network visualization with Canvas
        function renderNetwork() {
            const canvas = document.getElementById('networkCanvas');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (allNodes.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No hay nodos para visualizar. Crea algunos nodos primero.', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Calculate node positions in a circle
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 80;

            const nodePositions = {};
            allNodes.forEach((node, index) => {
                const angle = (index / allNodes.length) * 2 * Math.PI;
                nodePositions[node.id] = {
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle),
                    node: node
                };
            });

            // Draw connections (edges) first
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;

            allEvents.forEach(event => {
                if (!event.nodes || event.nodes.length < 2) return;

                // Draw lines between all nodes in the event
                for (let i = 0; i < event.nodes.length; i++) {
                    for (let j = i + 1; j < event.nodes.length; j++) {
                        const node1Pos = nodePositions[event.nodes[i]];
                        const node2Pos = nodePositions[event.nodes[j]];

                        if (node1Pos && node2Pos) {
                            ctx.beginPath();
                            ctx.moveTo(node1Pos.x, node1Pos.y);
                            ctx.lineTo(node2Pos.x, node2Pos.y);
                            ctx.stroke();
                        }
                    }
                }
            });

            // Draw nodes
            Object.values(nodePositions).forEach(pos => {
                const node = pos.node;

                // Determine node color based on highest value
                let color = node.color || '#3498db';
                if ((node.romanticValue || 0) >= 7) color = '#e74c3c'; // Red for romantic
                else if ((node.socialValue || 0) >= 7) color = '#27ae60'; // Green for social
                else if ((node.trustLevel || 0) >= 8) color = '#3498db'; // Blue for trust

                // Draw node circle
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 25, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Draw node label
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(node.name, pos.x, pos.y + 45);

                // Draw event count
                const eventCount = countNodeEvents(node.id);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px Arial';
                ctx.fillText(eventCount, pos.x, pos.y + 5);
            });
        }

        window.refreshNetwork = function() {
            renderNetwork();
        };

        // Render analytics
        function renderAnalytics() {
            const topRomantic = [...allNodes].sort((a, b) => (b.romanticValue || 0) - (a.romanticValue || 0)).slice(0, 5);
            const topSocial = [...allNodes].sort((a, b) => (b.socialValue || 0) - (a.socialValue || 0)).slice(0, 5);
            const topTrust = [...allNodes].sort((a, b) => (b.trustLevel || 0) - (a.trustLevel || 0)).slice(0, 5);

            const avgRomantic = allNodes.length > 0 ? (allNodes.reduce((sum, n) => sum + (n.romanticValue || 0), 0) / allNodes.length).toFixed(1) : 0;
            const avgSocial = allNodes.length > 0 ? (allNodes.reduce((sum, n) => sum + (n.socialValue || 0), 0) / allNodes.length).toFixed(1) : 0;
            const avgTrust = allNodes.length > 0 ? (allNodes.reduce((sum, n) => sum + (n.trustLevel || 0), 0) / allNodes.length).toFixed(1) : 0;

            document.getElementById('analyticsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Valor Rom√°ntico Promedio</div>
                    <div class="stat-value">${avgRomantic}/10</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Valor Social Promedio</div>
                    <div class="stat-value">${avgSocial}/10</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Confianza Promedio</div>
                    <div class="stat-value">${avgTrust}/10</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Nodos</div>
                    <div class="stat-value">${allNodes.length}</div>
                </div>
            `;

            document.getElementById('topNodes').innerHTML = `
                <div class="form-row">
                    <div>
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">üíï Top Rom√°ntico</h3>
                        ${topRomantic.map(n => `<p>‚Ä¢ ${n.name} (${n.romanticValue || 0}/10)</p>`).join('') || '<p>No hay datos</p>'}
                    </div>
                    <div>
                        <h3 style="color: #27ae60; margin-bottom: 10px;">üåü Top Social</h3>
                        ${topSocial.map(n => `<p>‚Ä¢ ${n.name} (${n.socialValue || 0}/10)</p>`).join('') || '<p>No hay datos</p>'}
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <h3 style="color: #3498db; margin-bottom: 10px;">üîí Top Confianza</h3>
                    ${topTrust.map(n => `<p>‚Ä¢ ${n.name} (${n.trustLevel || 0}/10)</p>`).join('') || '<p>No hay datos</p>'}
                </div>
            `;
        }

        // Render spawn analysis
        function renderSpawnAnalysis() {
            const placeStats = {};
            allEvents.forEach(evt => {
                if (!placeStats[evt.place]) {
                    placeStats[evt.place] = { count: 0, nodes: new Set(), highValue: 0 };
                }
                placeStats[evt.place].count++;
                if (evt.nodes) {
                    evt.nodes.forEach(nid => {
                        placeStats[evt.place].nodes.add(nid);
                        const node = allNodes.find(n => n.id === nid);
                        if (node && ((node.romanticValue || 0) >= 7 || (node.socialValue || 0) >= 7)) {
                            placeStats[evt.place].highValue++;
                        }
                    });
                }
            });

            const sortedPlaces = Object.entries(placeStats)
                .map(([place, stats]) => ({
                    place,
                    ...stats,
                    uniqueNodes: stats.nodes.size,
                    spawnRate: stats.uniqueNodes / stats.count
                }))
                .sort((a, b) => b.highValue - a.highValue);

            document.getElementById('spawnAnalysis').innerHTML = `
                <p style="margin-bottom: 20px;">An√°lisis de lugares donde aparecen nodos de alto valor (rom√°ntico ‚â•7 o social ‚â•7)</p>
                ${sortedPlaces.map(place => `
                    <div class="node-card">
                        <h3>üìç ${place.place}</h3>
                        <div class="kpi-grid" style="margin-top: 15px;">
                            <div class="kpi-item">
                                <div class="kpi-label">High-Value Nodes</div>
                                <div class="kpi-value">${place.highValue}</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Total Eventos</div>
                                <div class="kpi-value">${place.count}</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Nodos √önicos</div>
                                <div class="kpi-value">${place.uniqueNodes}</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Spawn Rate</div>
                                <div class="kpi-value">${place.spawnRate.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p>No hay datos suficientes para an√°lisis</p>'}
            `;
        }

        // Render profile
        async function renderProfile() {
            await loadOwnData();
        }

        // Load OwnData
        async function loadOwnData() {
            try {
                const q = query(collection(db, 'ownData'), where('user', '==', currentUser));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const data = querySnapshot.docs[0].data();

                    document.getElementById('ownHobbies').value = data.hobbies || '';
                    document.getElementById('ownCurrentActivities').value = data.currentActivities || '';
                    document.getElementById('ownIsInLove').value = data.isInLove || 'single';
                    document.getElementById('ownAvailability').value = data.availability || 'medium';
                    document.getElementById('ownJob').value = data.job || '';
                    document.getElementById('ownLongTermGoals').value = data.longTermGoals || '';
                    document.getElementById('ownDreamsAchieved').value = data.dreamsAchieved || '';
                    document.getElementById('ownInvolvement').value = data.involvement || 5;
                    document.getElementById('ownFitness').value = data.fitness || 5;
                    document.getElementById('ownOriginality').value = data.originality || 5;
                    document.getElementById('ownEgoism').value = data.egoism || 5;
                    document.getElementById('ownIntelligence').value = data.intelligence || 5;
                    document.getElementById('ownMusicTaste').value = data.musicTaste || '';

                    updateAllOwnSliders();
                    updateOwnDataSummary(data);
                }
            } catch (error) {
                console.error('Error loading OwnData:', error);
            }
        }

        // Save OwnData
        window.saveOwnData = async function() {
            const ownData = {
                user: currentUser,
                hobbies: document.getElementById('ownHobbies').value,
                currentActivities: document.getElementById('ownCurrentActivities').value,
                isInLove: document.getElementById('ownIsInLove').value,
                availability: document.getElementById('ownAvailability').value,
                job: document.getElementById('ownJob').value,
                longTermGoals: document.getElementById('ownLongTermGoals').value,
                dreamsAchieved: document.getElementById('ownDreamsAchieved').value,
                involvement: parseInt(document.getElementById('ownInvolvement').value),
                fitness: parseInt(document.getElementById('ownFitness').value),
                originality: parseInt(document.getElementById('ownOriginality').value),
                egoism: parseInt(document.getElementById('ownEgoism').value),
                intelligence: parseInt(document.getElementById('ownIntelligence').value),
                musicTaste: document.getElementById('ownMusicTaste').value,
                updatedAt: new Date().toISOString()
            };

            try {
                const q = query(collection(db, 'ownData'), where('user', '==', currentUser));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    ownData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'ownData'), ownData);
                } else {
                    const docId = querySnapshot.docs[0].id;
                    await updateDoc(doc(db, 'ownData', docId), ownData);
                }

                alert('Perfil guardado correctamente');
                updateOwnDataSummary(ownData);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar perfil: ' + error.message);
            }
        };

        // Update OwnData summary
        function updateOwnDataSummary(data) {
            const avgScore = ((data.involvement + data.fitness + data.originality + data.intelligence) / 4).toFixed(1);

            document.getElementById('ownDataSummary').innerHTML = `
                <h3 style="color: #1e3c72; margin-bottom: 15px;">Resumen de tu Perfil</h3>
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <div class="kpi-label">Puntuaci√≥n General</div>
                        <div class="kpi-value">${avgScore}/10</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-label">Social</div>
                        <div class="kpi-value">${data.involvement}/10</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-label">Fitness</div>
                        <div class="kpi-value">${data.fitness}/10</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-label">Inteligencia</div>
                        <div class="kpi-value">${data.intelligence}/10</div>
                    </div>
                </div>
                <p style="margin-top: 15px;"><strong>Estado:</strong> ${data.isInLove === 'single' ? 'Soltero/a' : data.isInLove === 'relationship' ? 'En relaci√≥n' : data.isInLove}</p>
                <p><strong>Disponibilidad:</strong> ${data.availability === 'high' ? 'Alta' : data.availability === 'medium' ? 'Media' : 'Baja'}</p>
                ${data.job ? `<p><strong>Ocupaci√≥n:</strong> ${data.job}</p>` : ''}
                ${data.hobbies ? `<p><strong>Hobbies:</strong> ${data.hobbies}</p>` : ''}
            `;
        }

        // Update own slider
        window.updateOwnSlider = function(name) {
            const slider = document.getElementById('own' + name);
            const display = document.getElementById('own' + name + 'Display');
            display.textContent = slider.value;
        };

        function updateAllOwnSliders() {
            ['Involvement', 'Fitness', 'Originality', 'Egoism', 'Intelligence'].forEach(name => {
                updateOwnSlider(name);
            });
        }

        // Count node events
        function countNodeEvents(nodeId) {
            return allEvents.filter(evt => evt.nodes && evt.nodes.includes(nodeId)).length;
        }

        // Modal functions
        window.openNodeModal = function() {
            currentNodeId = null;
            document.getElementById('nodeForm').reset();
            document.getElementById('nodeName').value = '';
            document.getElementById('deleteNodeBtn').style.display = 'none';
            updateSlider('romanticValue');
            updateSlider('socialValue');
            updateSlider('trustLevel');
            document.getElementById('nodeModal').style.display = 'block';
        };

        window.closeNodeModal = function() {
            document.getElementById('nodeModal').style.display = 'none';
        };

        window.openEventModal = function() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventDate').valueAsDate = new Date();

            // Populate nodes selector
            const select = document.getElementById('eventNodes');
            select.innerHTML = allNodes.map(n => `<option value="${n.id}">${n.name}</option>`).join('');

            document.getElementById('eventModal').style.display = 'block';
        };

        window.closeEventModal = function() {
            document.getElementById('eventModal').style.display = 'none';
        };

        window.updateSlider = function(name) {
            const slider = document.getElementById('node' + name.charAt(0).toUpperCase() + name.slice(1));
            const display = document.getElementById(name + 'Display');
            display.textContent = slider.value;
        };

        // Edit node
        window.editNode = function(nodeId) {
            const node = allNodes.find(n => n.id === nodeId);
            if (!node) return;

            currentNodeId = nodeId;
            document.getElementById('nodeName').value = node.name || '';
            document.getElementById('nodeAge').value = node.age || '';
            document.getElementById('nodeColor').value = node.color || '#3498db';
            document.getElementById('nodeJob').value = node.job || '';
            document.getElementById('nodeHobbies').value = node.hobbies || '';
            document.getElementById('nodeLongTermGoals').value = node.longTermGoals || '';
            document.getElementById('nodeIsInLove').value = node.isInLove || 'no';
            document.getElementById('nodeRelationType').value = node.relationType || '';
            document.getElementById('nodeRomanticValue').value = node.romanticValue || 5;
            document.getElementById('nodeSocialValue').value = node.socialValue || 5;
            document.getElementById('nodeTrustLevel').value = node.trustLevel || 5;
            document.getElementById('nodePlaces').value = node.places || '';
            document.getElementById('nodeHighlights').value = node.highlights || '';

            updateSlider('romanticValue');
            updateSlider('socialValue');
            updateSlider('trustLevel');

            document.getElementById('deleteNodeBtn').style.display = 'inline-block';
            document.getElementById('nodeModal').style.display = 'block';
        };

        // Save node
        window.saveNode = async function(e) {
            e.preventDefault();

            const nodeData = {
                user: currentUser,
                name: document.getElementById('nodeName').value,
                age: parseInt(document.getElementById('nodeAge').value) || null,
                color: document.getElementById('nodeColor').value,
                job: document.getElementById('nodeJob').value,
                hobbies: document.getElementById('nodeHobbies').value,
                longTermGoals: document.getElementById('nodeLongTermGoals').value,
                isInLove: document.getElementById('nodeIsInLove').value,
                relationType: document.getElementById('nodeRelationType').value,
                romanticValue: parseInt(document.getElementById('nodeRomanticValue').value),
                socialValue: parseInt(document.getElementById('nodeSocialValue').value),
                trustLevel: parseInt(document.getElementById('nodeTrustLevel').value),
                places: document.getElementById('nodePlaces').value,
                highlights: document.getElementById('nodeHighlights').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (currentNodeId) {
                    await updateDoc(doc(db, 'nodes', currentNodeId), nodeData);
                    alert('Nodo actualizado correctamente');
                } else {
                    nodeData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'nodes'), nodeData);
                    alert('Nodo creado correctamente');
                }
                closeNodeModal();
                await loadNodes();
                renderNodes();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el nodo: ' + error.message);
            }
        };

        // Delete node
        window.deleteNode = async function() {
            if (!currentNodeId) return;
            if (!confirm('¬øEst√°s seguro de eliminar este nodo?')) return;

            try {
                await deleteDoc(doc(db, 'nodes', currentNodeId));
                alert('Nodo eliminado correctamente');
                closeNodeModal();
                await loadNodes();
                renderNodes();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el nodo: ' + error.message);
            }
        };

        // Save event
        window.saveEvent = async function(e) {
            e.preventDefault();

            const selectedNodes = Array.from(document.getElementById('eventNodes').selectedOptions).map(opt => opt.value);

            const eventData = {
                user: currentUser,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                nodes: selectedNodes,
                place: document.getElementById('eventPlace').value,
                weather: document.getElementById('eventWeather').value,
                outfit: document.getElementById('eventOutfit').value,
                peopleCount: parseInt(document.getElementById('eventPeopleCount').value) || null,
                situation: document.getElementById('eventSituation').value,
                environment: document.getElementById('eventEnvironment').value,
                notes: document.getElementById('eventNotes').value,
                createdAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'events'), eventData);
                alert('Evento guardado correctamente');
                closeEventModal();
                await loadEvents();
                renderEvents();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el evento: ' + error.message);
            }
        };

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Export functions
        function escapeCSV(str) {
            if (str === null || str === undefined) return '';
            str = String(str);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export nodes to CSV
        window.exportNodes = function() {
            if (allNodes.length === 0) {
                alert('No hay nodos para exportar');
                return;
            }

            const headers = [
                'Nombre',
                'Edad',
                'Trabajo',
                'Hobbies',
                'Objetivos Largo Plazo',
                'Est√° Enamorado',
                'Tipo Relaci√≥n',
                'Valor Rom√°ntico',
                'Valor Social',
                'Nivel Confianza',
                'Lugares',
                'Highlights',
                'Color',
                'Fecha Creaci√≥n'
            ];

            let csv = headers.join(',') + '\n';

            allNodes.forEach(node => {
                const row = [
                    escapeCSV(node.name),
                    node.age || '',
                    escapeCSV(node.job),
                    escapeCSV(node.hobbies),
                    escapeCSV(node.longTermGoals),
                    escapeCSV(node.isInLove),
                    escapeCSV(node.relationType),
                    node.romanticValue || 0,
                    node.socialValue || 0,
                    node.trustLevel || 0,
                    escapeCSV(node.places),
                    escapeCSV(node.highlights),
                    node.color || '',
                    escapeCSV(node.createdAt)
                ];
                csv += row.join(',') + '\n';
            });

            const filename = `nodes-${currentUser}-${new Date().toISOString().split('T')[0]}.csv`;
            downloadFile(csv, filename, 'text/csv;charset=utf-8;');
        };

        // Export events to CSV
        window.exportEvents = function() {
            if (allEvents.length === 0) {
                alert('No hay eventos para exportar');
                return;
            }

            const headers = [
                'Fecha',
                'Hora',
                'Lugar',
                'Nodos',
                'Clima',
                'Outfit',
                'N√∫mero Personas',
                'Situaci√≥n',
                'Ambiente',
                'Notas',
                'Fecha Creaci√≥n'
            ];

            let csv = headers.join(',') + '\n';

            allEvents.forEach(evt => {
                const nodeNames = evt.nodes ? evt.nodes.map(nid => {
                    const node = allNodes.find(n => n.id === nid);
                    return node ? node.name : 'Desconocido';
                }).join('; ') : '';

                const row = [
                    escapeCSV(evt.date),
                    escapeCSV(evt.time),
                    escapeCSV(evt.place),
                    escapeCSV(nodeNames),
                    escapeCSV(evt.weather),
                    escapeCSV(evt.outfit),
                    evt.peopleCount || '',
                    escapeCSV(evt.situation),
                    escapeCSV(evt.environment),
                    escapeCSV(evt.notes),
                    escapeCSV(evt.createdAt)
                ];
                csv += row.join(',') + '\n';
            });

            const filename = `events-${currentUser}-${new Date().toISOString().split('T')[0]}.csv`;
            downloadFile(csv, filename, 'text/csv;charset=utf-8;');
        };

        // Export all data to JSON
        window.exportAllData = async function() {
            if (allNodes.length === 0 && allEvents.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Load OwnData
            let ownData = null;
            try {
                const q = query(collection(db, 'ownData'), where('user', '==', currentUser));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    ownData = querySnapshot.docs[0].data();
                }
            } catch (error) {
                console.error('Error loading OwnData for export:', error);
            }

            const exportData = {
                user: currentUser,
                exportDate: new Date().toISOString(),
                nodes: allNodes,
                events: allEvents,
                ownData: ownData,
                stats: {
                    totalNodes: allNodes.length,
                    totalEvents: allEvents.length,
                    avgRomanticValue: allNodes.length > 0 ? (allNodes.reduce((sum, n) => sum + (n.romanticValue || 0), 0) / allNodes.length).toFixed(2) : 0,
                    avgSocialValue: allNodes.length > 0 ? (allNodes.reduce((sum, n) => sum + (n.socialValue || 0), 0) / allNodes.length).toFixed(2) : 0,
                    avgTrustLevel: allNodes.length > 0 ? (allNodes.reduce((sum, n) => sum + (n.trustLevel || 0), 0) / allNodes.length).toFixed(2) : 0
                }
            };

            const json = JSON.stringify(exportData, null, 2);
            const filename = `social-graph-${currentUser}-${new Date().toISOString().split('T')[0]}.json`;
            downloadFile(json, filename, 'application/json');
        };
    </script>
</body>
</html>
